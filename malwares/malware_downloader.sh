#!/bin/bash

# Bash script to download Malware Bazaar based on file_type

# Define file type and number of samples to download
TYPE=elf
DOWNLOAD_LIMIT=500

# Determin OS
OS=$(uname -s)

# Download hash values from type, save the SHA256 hashes
curl -XPOST -d "query=get_file_type&file_type=${TYPE}&limit=${DOWNLOAD_LIMIT}" https://mb-api.abuse.ch/api/v1/ | grep sha256_hash | awk '{print $2}' > ${TYPE}.raw

cat ${TYPE}.raw
# OS Loop
# If macOS, clean up the download to remove "'s and ,'s
if [ ${OS} == Darwin ];
then
sed -i.bak 's/\"//g' ${TYPE}.raw
rm ${TYPE}.raw.bak
sed -i.bak 's/\,//' ${TYPE}.raw
rm ${TYPE}.raw.bak

# If Linux, clean up the download to remove "'s and ,'s
elif [ "${OS}" == "Linux" ];
then
echo "Linux OS: stripping quotes ..."
sed -i 's/\"//g' ${TYPE}.raw
sed -i 's/\,//g' ${TYPE}.raw

# Exiting OS loop
fi

# Create the hash file from the raw file
mv ${TYPE}.raw ${TYPE}.hash

# Download the samples using their hash vaules
while read h; do curl -XPOST -d "query=get_file&sha256_hash=${h}" -o ${h} https://mb-api.abuse.ch/api/v1/; done < ${TYPE}.hash

# Unarchive the malware samples: password is "infected"
while read h; do 7z e ${h} -p"infected"; done < ${TYPE}.hash

# Clean up by removing the hash lists and compressed archives files
while read h; do rm ${h}; done < ${TYPE}.hash
rm ${TYPE}.raw.bak
rm ${TYPE}.hash